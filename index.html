<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feeder Capture Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .tab-active { background-color: #2563eb; color: white; }
        .editable:hover { background-color: #fef3c7; cursor: pointer; }
        .dropdown-menu { max-height: 300px; overflow-y: auto; }
        .sticky-col { position: sticky; left: 0; z-index: 10; }
        .merge-indicator { border-left: 4px solid #22c55e; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            activeTab: 'upload',
            feederLookup: {},
            uploadedFiles: {
                mappedDT: null,
                htPoles: null,
                ltPoles: null,
                consumerPoints: null,
                issueLog: null
            },
            dateRange: {
                start: new Date().toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            },
            generatedReport: null,
            previousWeekReport: null,
            feederCorrections: {},
            showCorrectionModal: false,
            unmatchedFeeders: [],
            editingFeeder: null
        };

        // Load saved data from localStorage
        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('feederDashboard');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.feederLookup) state.feederLookup = data.feederLookup;
                    if (data.previousWeekReport) state.previousWeekReport = data.previousWeekReport;
                }
            } catch (e) {
                console.error('Error loading from storage:', e);
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('feederDashboard', JSON.stringify({
                    feederLookup: state.feederLookup,
                    previousWeekReport: state.previousWeekReport
                }));
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        // ============================================
        // EXCEL PARSING UTILITIES
        // ============================================
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(sheet);
                        resolve(json);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseFeederLookup(data) {
            const lookup = {};
            data.forEach(row => {
                const code = String(Object.values(row)[0] || '').trim();
                const name = String(Object.values(row)[1] || '').trim();
                if (code && name) {
                    lookup[code.toLowerCase()] = name;
                }
            });
            return lookup;
        }

        function matchFeederName(rawFeeder, lookup) {
            if (!rawFeeder) return { matched: '', raw: '' };
            const raw = String(rawFeeder).trim();
            const lowerRaw = raw.toLowerCase();
            
            // Direct match
            if (lookup[lowerRaw]) {
                return { matched: lookup[lowerRaw], raw };
            }
            
            // Check if raw is contained in any lookup value
            for (const [code, fullName] of Object.entries(lookup)) {
                const lowerFull = fullName.toLowerCase();
                // Check if the raw feeder code is a segment in the full name
                if (lowerFull.includes(lowerRaw) || 
                    lowerFull.includes('_' + lowerRaw) || 
                    lowerFull.includes(lowerRaw + '_') ||
                    lowerFull.endsWith(' ' + lowerRaw)) {
                    return { matched: fullName, raw };
                }
            }
            
            // Check if any code matches
            for (const [code, fullName] of Object.entries(lookup)) {
                if (lowerRaw.includes(code) || code.includes(lowerRaw)) {
                    return { matched: fullName, raw };
                }
            }
            
            return { matched: raw, raw };
        }

        function isDateInRange(dateValue, startDate, endDate) {
            if (!dateValue) return false;
            
            let date;
            if (typeof dateValue === 'number') {
                // Excel serial date
                date = new Date((dateValue - 25569) * 86400 * 1000);
            } else if (typeof dateValue === 'string') {
                date = new Date(dateValue);
            } else if (dateValue instanceof Date) {
                date = dateValue;
            } else {
                return false;
            }
            
            if (isNaN(date.getTime())) return false;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            
            return date >= start && date <= end;
        }

        function findColumnValue(row, possibleNames) {
            for (const name of possibleNames) {
                const lowerName = name.toLowerCase();
                for (const key of Object.keys(row)) {
                    if (key.toLowerCase().includes(lowerName) || lowerName.includes(key.toLowerCase())) {
                        return row[key];
                    }
                }
            }
            return null;
        }

        function getTimeValue(row) {
            return findColumnValue(row, ['time', 'date', 'timestamp', 'created', 'submitted']);
        }

        function getFeederValue(row, type) {
            if (type === 'htPoles') {
                // Check both 11kv and 33kv feeder columns
                const f33 = findColumnValue(row, ['_33kv_feeder', '33kv_feeder', '33kvfeeder']);
                const f11 = findColumnValue(row, ['_11kv_feeder', '11kv_feeder', '11kvfeeder']);
                return f33 || f11 || findColumnValue(row, ['feeder']);
            }
            return findColumnValue(row, ['feeder', 'feeder_name', 'feedername']);
        }

        // ============================================
        // REPORT GENERATION
        // ============================================
        function generateReport() {
            const report = {};
            const unmatchedFromIssueLog = new Set();
            
            const processFile = (data, type) => {
                if (!data) return;
                
                data.forEach(row => {
                    const timeValue = getTimeValue(row);
                    const inRange = isDateInRange(timeValue, state.dateRange.start, state.dateRange.end);
                    
                    let rawFeeder = getFeederValue(row, type);
                    if (!rawFeeder) return;
                    
                    // Apply corrections for issue log
                    if (type === 'issueLog' && state.feederCorrections[String(rawFeeder).trim()]) {
                        rawFeeder = state.feederCorrections[String(rawFeeder).trim()];
                    }
                    
                    const { matched, raw } = matchFeederName(rawFeeder, state.feederLookup);
                    
                    // Track unmatched issue log feeders
                    if (type === 'issueLog' && matched === raw && raw !== '') {
                        const lookupValues = Object.values(state.feederLookup);
                        if (!lookupValues.some(v => v.toLowerCase() === matched.toLowerCase())) {
                            unmatchedFromIssueLog.add(raw);
                        }
                    }
                    
                    const feederKey = matched || raw;
                    if (!feederKey) return;
                    
                    if (!report[feederKey]) {
                        report[feederKey] = {
                            feederName: feederKey,
                            rawFeederName: raw,
                            isEdited: false,
                            isMatched: matched !== raw,
                            mappedDT: { weekly: 0, total: 0 },
                            htPoles: { weekly: 0, total: 0 },
                            ltPoles: { weekly: 0, total: 0 },
                            consumerPoints: { weekly: 0, total: 0 },
                            issueLog: { weekly: 0, total: 0 }
                        };
                    }
                    
                    const entry = report[feederKey];
                    
                    switch (type) {
                        case 'mappedDT':
                            entry.mappedDT.total++;
                            if (inRange) entry.mappedDT.weekly++;
                            break;
                        case 'htPoles':
                            entry.htPoles.total++;
                            if (inRange) entry.htPoles.weekly++;
                            break;
                        case 'ltPoles':
                            entry.ltPoles.total++;
                            if (inRange) entry.ltPoles.weekly++;
                            break;
                        case 'consumerPoints':
                            entry.consumerPoints.total++;
                            if (inRange) entry.consumerPoints.weekly++;
                            break;
                        case 'issueLog':
                            entry.issueLog.total++;
                            if (inRange) entry.issueLog.weekly++;
                            break;
                    }
                });
            };
            
            processFile(state.uploadedFiles.mappedDT, 'mappedDT');
            processFile(state.uploadedFiles.htPoles, 'htPoles');
            processFile(state.uploadedFiles.ltPoles, 'ltPoles');
            processFile(state.uploadedFiles.consumerPoints, 'consumerPoints');
            processFile(state.uploadedFiles.issueLog, 'issueLog');
            
            state.generatedReport = {
                data: Object.values(report),
                dateRange: { ...state.dateRange },
                generatedAt: new Date().toISOString()
            };
            
            // Check for unmatched feeders
            state.unmatchedFeeders = Array.from(unmatchedFromIssueLog);
            if (state.unmatchedFeeders.length > 0) {
                state.showCorrectionModal = true;
            }
            
            render();
        }

        function mergeFeederInReport(oldName, newName) {
            if (!state.generatedReport) return;
            
            const data = state.generatedReport.data;
            const oldIndex = data.findIndex(r => r.feederName === oldName);
            const existingIndex = data.findIndex(r => r.feederName === newName);
            
            if (oldIndex === -1) return;
            
            if (existingIndex !== -1 && existingIndex !== oldIndex) {
                // Merge values
                const oldRow = data[oldIndex];
                const existingRow = data[existingIndex];
                
                existingRow.mappedDT.weekly += oldRow.mappedDT.weekly;
                existingRow.mappedDT.total += oldRow.mappedDT.total;
                existingRow.htPoles.weekly += oldRow.htPoles.weekly;
                existingRow.htPoles.total += oldRow.htPoles.total;
                existingRow.ltPoles.weekly += oldRow.ltPoles.weekly;
                existingRow.ltPoles.total += oldRow.ltPoles.total;
                existingRow.consumerPoints.weekly += oldRow.consumerPoints.weekly;
                existingRow.consumerPoints.total += oldRow.consumerPoints.total;
                existingRow.issueLog.weekly += oldRow.issueLog.weekly;
                existingRow.issueLog.total += oldRow.issueLog.total;
                
                // Remove old row
                data.splice(oldIndex, 1);
            } else {
                // Just rename
                data[oldIndex].feederName = newName;
                data[oldIndex].isEdited = true;
            }
            
            render();
        }

        function updateReportValue(feederName, field, subField, value) {
            if (!state.generatedReport) return;
            
            const row = state.generatedReport.data.find(r => r.feederName === feederName);
            if (row && row[field]) {
                row[field][subField] = parseInt(value) || 0;
            }
            render();
        }

        function saveAsPreviousWeek() {
            if (state.generatedReport) {
                state.previousWeekReport = JSON.parse(JSON.stringify(state.generatedReport));
                state.previousWeekReport.savedAt = new Date().toISOString();
                saveToStorage();
                alert('Report saved as Previous Week!');
                render();
            }
        }

        function exportToExcel(report, filename) {
            if (!report) return;
            
            const exportData = report.data.map(row => ({
                'Feeder Name': row.feederName,
                'Mapped DT (Weekly)': row.mappedDT.weekly,
                'Mapped DT (Total)': row.mappedDT.total,
                'HT Poles (Weekly)': row.htPoles.weekly,
                'HT Poles (Total)': row.htPoles.total,
                'LT Poles (Weekly)': row.ltPoles.weekly,
                'LT Poles (Total)': row.ltPoles.total,
                'Consumer Points (Weekly)': row.consumerPoints.weekly,
                'Consumer Points (Total)': row.consumerPoints.total,
                'Issue Log (Weekly)': row.issueLog.weekly,
                'Issue Log (Total)': row.issueLog.total
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            XLSX.writeFile(wb, filename);
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen">
                    ${renderHeader()}
                    ${renderTabs()}
                    <div class="container mx-auto px-4 py-6">
                        ${state.activeTab === 'upload' ? renderUploadTab() : ''}
                        ${state.activeTab === 'report' ? renderReportTab() : ''}
                        ${state.activeTab === 'previous' ? renderPreviousTab() : ''}
                        ${state.activeTab === 'comparison' ? renderComparisonTab() : ''}
                    </div>
                    ${state.showCorrectionModal ? renderCorrectionModal() : ''}
                </div>
            `;
            attachEventListeners();
        }

        function renderHeader() {
            return `
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-6 px-4 shadow-lg">
                    <div class="container mx-auto">
                        <h1 class="text-3xl font-bold">‚ö° Feeder Capture Dashboard</h1>
                        <p class="text-blue-100 mt-2">Asset Management & Reporting System</p>
                    </div>
                </div>
            `;
        }

        function renderTabs() {
            const tabs = [
                { id: 'upload', label: 'üìÅ Upload & Config' },
                { id: 'report', label: 'üìä Generated Report' },
                { id: 'previous', label: 'üìã Previous Week' },
                { id: 'comparison', label: 'üîÑ Comparison' }
            ];
            
            return `
                <div class="bg-white shadow">
                    <div class="container mx-auto px-4">
                        <div class="flex space-x-1">
                            ${tabs.map(tab => `
                                <button 
                                    class="px-6 py-3 font-medium rounded-t-lg transition-colors ${state.activeTab === tab.id ? 'tab-active' : 'text-gray-600 hover:bg-gray-100'}"
                                    data-tab="${tab.id}"
                                >
                                    ${tab.label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUploadTab() {
            const fileStatuses = {
                feederLookup: Object.keys(state.feederLookup).length > 0,
                mappedDT: state.uploadedFiles.mappedDT !== null,
                htPoles: state.uploadedFiles.htPoles !== null,
                ltPoles: state.uploadedFiles.ltPoles !== null,
                consumerPoints: state.uploadedFiles.consumerPoints !== null,
                issueLog: state.uploadedFiles.issueLog !== null
            };
            
            return `
                <div class="space-y-6">
                    <!-- Feeder Lookup -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">üìã Feeder Lookup (One-time Configuration)</h2>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="feederLookupFile" accept=".xlsx,.xls,.csv" class="hidden">
                            <button onclick="document.getElementById('feederLookupFile').click()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Upload Feeder Lookup
                            </button>
                            <span class="${fileStatuses.feederLookup ? 'text-green-600' : 'text-gray-400'}">
                                ${fileStatuses.feederLookup ? `‚úÖ ${Object.keys(state.feederLookup).length} feeders loaded` : '‚è≥ Not uploaded'}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Asset Files -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">üìÇ Asset Files</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderFileUpload('mappedDT', 'Mapped DT by GIS', fileStatuses.mappedDT)}
                            ${renderFileUpload('htPoles', 'HT Poles', fileStatuses.htPoles)}
                            ${renderFileUpload('ltPoles', 'LT Poles', fileStatuses.ltPoles)}
                            ${renderFileUpload('consumerPoints', 'Consumer Points', fileStatuses.consumerPoints)}
                            ${renderFileUpload('issueLog', 'Issue Log', fileStatuses.issueLog)}
                        </div>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">üìÖ Date Range for Weekly Filter</h2>
                        <div class="flex items-center space-x-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Start Date</label>
                                <input type="date" id="startDate" value="${state.dateRange.start}" 
                                    class="mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">End Date</label>
                                <input type="date" id="endDate" value="${state.dateRange.end}"
                                    class="mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <div class="flex justify-center">
                        <button id="generateBtn" 
                            class="px-8 py-4 bg-green-600 text-white text-xl font-bold rounded-lg hover:bg-green-700 shadow-lg transition-transform hover:scale-105">
                            üöÄ Generate Report
                        </button>
                    </div>
                </div>
            `;
        }

        function renderFileUpload(id, label, isUploaded) {
            return `
                <div class="border rounded-lg p-4 ${isUploaded ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium">${label}</span>
                        <span class="${isUploaded ? 'text-green-600' : 'text-gray-400'}">
                            ${isUploaded ? '‚úÖ' : '‚è≥'}
                        </span>
                    </div>
                    <input type="file" id="${id}File" accept=".xlsx,.xls,.csv" class="hidden">
                    <button onclick="document.getElementById('${id}File').click()" 
                        class="w-full px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200">
                        ${isUploaded ? 'Replace File' : 'Upload File'}
                    </button>
                </div>
            `;
        }

        function renderReportTab() {
            if (!state.generatedReport) {
                return `
                    <div class="bg-white rounded-lg shadow p-12 text-center">
                        <p class="text-gray-500 text-xl">No report generated yet.</p>
                        <p class="text-gray-400 mt-2">Go to Upload & Config tab to generate a report.</p>
                    </div>
                `;
            }
            
            const report = state.generatedReport;
            const totals = calculateTotals(report.data);
            
            return `
                <div class="space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        ${renderSummaryCard('Mapped DT', totals.mappedDT, 'bg-blue-500')}
                        ${renderSummaryCard('HT Poles', totals.htPoles, 'bg-purple-500')}
                        ${renderSummaryCard('LT Poles', totals.ltPoles, 'bg-green-500')}
                        ${renderSummaryCard('Consumer Points', totals.consumerPoints, 'bg-orange-500')}
                        ${renderSummaryCard('Issue Log', totals.issueLog, 'bg-red-500')}
                    </div>
                    
                    <!-- Report Info -->
                    <div class="bg-white rounded-lg shadow p-4 flex justify-between items-center">
                        <div>
                            <span class="text-gray-600">Date Range: </span>
                            <span class="font-bold">${report.dateRange.start} to ${report.dateRange.end}</span>
                            <span class="text-gray-400 ml-4">Generated: ${new Date(report.generatedAt).toLocaleString()}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="saveAsPreviousWeek()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                üíæ Save as Previous Week
                            </button>
                            <button onclick="exportToExcel(state.generatedReport, 'report_${report.dateRange.start}_${report.dateRange.end}.xlsx')"
                                class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                üì• Export to Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Report Table -->
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left sticky-col bg-gray-800" style="min-width: 350px;">Feeder Name</th>
                                    <th class="px-4 py-3 text-center" colspan="2">Mapped DT</th>
                                    <th class="px-4 py-3 text-center" colspan="2">HT Poles</th>
                                    <th class="px-4 py-3 text-center" colspan="2">LT Poles</th>
                                    <th class="px-4 py-3 text-center" colspan="2">Consumer Points</th>
                                    <th class="px-4 py-3 text-center" colspan="2">Issue Log</th>
                                </tr>
                                <tr class="bg-gray-700">
                                    <th class="px-4 py-2 sticky-col bg-gray-700"></th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${report.data.map((row, idx) => renderReportRow(row, idx)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderSummaryCard(title, data, bgColor) {
            return `
                <div class="${bgColor} text-white rounded-lg shadow p-4">
                    <h3 class="text-sm font-medium opacity-90">${title}</h3>
                    <div class="mt-2">
                        <div class="text-2xl font-bold">${data.weekly}</div>
                        <div class="text-xs opacity-75">Weekly</div>
                    </div>
                    <div class="mt-1">
                        <div class="text-lg">${data.total}</div>
                        <div class="text-xs opacity-75">Total</div>
                    </div>
                </div>
            `;
        }

        function renderReportRow(row, idx) {
            const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
            const lookupFeeders = Object.values(state.feederLookup);
            
            return `
                <tr class="${bgClass} hover:bg-yellow-50">
                    <td class="px-4 py-3 sticky-col ${bgClass} border-r">
                        <div class="flex items-center justify-between">
                            <div class="flex-1" style="word-break: break-all;">
                                <span class="feeder-name-display cursor-pointer hover:text-blue-600" 
                                      data-feeder="${row.feederName}" 
                                      onclick="showFeederDropdown('${encodeURIComponent(row.feederName)}', this)">
                                    ${row.feederName}
                                </span>
                                ${row.isEdited ? '<span class="ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded">edited</span>' : ''}
                                ${row.isMatched && !row.isEdited ? '<span class="ml-2 px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded">matched</span>' : ''}
                            </div>
                            <span class="text-gray-400 ml-2">‚úèÔ∏è</span>
                        </div>
                        <div id="dropdown-${encodeURIComponent(row.feederName)}" class="hidden absolute z-50 mt-1 bg-white border rounded-lg shadow-xl" style="max-width: 400px;"></div>
                    </td>
                    ${renderEditableCell(row.feederName, 'mappedDT', 'weekly', row.mappedDT.weekly)}
                    ${renderEditableCell(row.feederName, 'mappedDT', 'total', row.mappedDT.total)}
                    ${renderEditableCell(row.feederName, 'htPoles', 'weekly', row.htPoles.weekly)}
                    ${renderEditableCell(row.feederName, 'htPoles', 'total', row.htPoles.total)}
                    ${renderEditableCell(row.feederName, 'ltPoles', 'weekly', row.ltPoles.weekly)}
                    ${renderEditableCell(row.feederName, 'ltPoles', 'total', row.ltPoles.total)}
                    ${renderEditableCell(row.feederName, 'consumerPoints', 'weekly', row.consumerPoints.weekly)}
                    ${renderEditableCell(row.feederName, 'consumerPoints', 'total', row.consumerPoints.total)}
                    ${renderEditableCell(row.feederName, 'issueLog', 'weekly', row.issueLog.weekly)}
                    ${renderEditableCell(row.feederName, 'issueLog', 'total', row.issueLog.total)}
                </tr>
            `;
        }

        function renderEditableCell(feederName, field, subField, value) {
            return `
                <td class="px-4 py-3 text-center editable" 
                    onclick="editCell(this, '${encodeURIComponent(feederName)}', '${field}', '${subField}', ${value})">
                    ${value}
                </td>
            `;
        }

        function showFeederDropdown(encodedFeederName, element) {
            const feederName = decodeURIComponent(encodedFeederName);
            const dropdownId = `dropdown-${encodedFeederName}`;
            const dropdown = document.getElementById(dropdownId);
            
            // Close all other dropdowns
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                if (d.id !== dropdownId) d.classList.add('hidden');
            });
            
            if (dropdown.classList.contains('hidden')) {
                const lookupFeeders = Object.values(state.feederLookup);
                const existingFeeders = state.generatedReport.data.map(r => r.feederName);
                
                dropdown.innerHTML = `
                    <div class="p-2 border-b">
                        <input type="text" id="feeder-search-${encodedFeederName}" placeholder="Search feeders..." 
                            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                            oninput="filterFeederDropdown('${encodedFeederName}')">
                    </div>
                    <div class="dropdown-menu" id="feeder-list-${encodedFeederName}">
                        <div class="p-2 bg-yellow-100 border-b cursor-pointer hover:bg-yellow-200"
                             onclick="selectFeeder('${encodedFeederName}', '${encodeURIComponent(feederName)}')">
                            üìå Keep: ${feederName}
                        </div>
                        ${lookupFeeders.map(f => {
                            const willMerge = existingFeeders.includes(f) && f !== feederName;
                            return `
                                <div class="p-2 cursor-pointer hover:bg-blue-100 ${willMerge ? 'merge-indicator' : ''}" 
                                     data-feeder="${f.toLowerCase()}"
                                     onclick="selectFeeder('${encodedFeederName}', '${encodeURIComponent(f)}')">
                                    ${f}
                                    ${willMerge ? '<span class="text-xs text-green-600 ml-2">‚ö° Will merge</span>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function filterFeederDropdown(encodedFeederName) {
            const search = document.getElementById(`feeder-search-${encodedFeederName}`).value.toLowerCase();
            const list = document.getElementById(`feeder-list-${encodedFeederName}`);
            const items = list.querySelectorAll('[data-feeder]');
            
            items.forEach(item => {
                const feeder = item.getAttribute('data-feeder');
                item.style.display = feeder.includes(search) ? 'block' : 'none';
            });
        }

        function selectFeeder(encodedOldName, encodedNewName) {
            const oldName = decodeURIComponent(encodedOldName);
            const newName = decodeURIComponent(encodedNewName);
            
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => d.classList.add('hidden'));
            
            if (oldName !== newName) {
                mergeFeederInReport(oldName, newName);
            }
        }

        function editCell(cell, encodedFeederName, field, subField, currentValue) {
            const feederName = decodeURIComponent(encodedFeederName);
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.className = 'w-16 px-2 py-1 text-center border rounded focus:ring-2 focus:ring-blue-500';
            
            input.onblur = function() {
                updateReportValue(feederName, field, subField, this.value);
            };
            
            input.onkeydown = function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                } else if (e.key === 'Escape') {
                    render();
                }
            };
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        function calculateTotals(data) {
            return data.reduce((acc, row) => {
                acc.mappedDT.weekly += row.mappedDT.weekly;
                acc.mappedDT.total += row.mappedDT.total;
                acc.htPoles.weekly += row.htPoles.weekly;
                acc.htPoles.total += row.htPoles.total;
                acc.ltPoles.weekly += row.ltPoles.weekly;
                acc.ltPoles.total += row.ltPoles.total;
                acc.consumerPoints.weekly += row.consumerPoints.weekly;
                acc.consumerPoints.total += row.consumerPoints.total;
                acc.issueLog.weekly += row.issueLog.weekly;
                acc.issueLog.total += row.issueLog.total;
                return acc;
            }, {
                mappedDT: { weekly: 0, total: 0 },
                htPoles: { weekly: 0, total: 0 },
                ltPoles: { weekly: 0, total: 0 },
                consumerPoints: { weekly: 0, total: 0 },
                issueLog: { weekly: 0, total: 0 }
            });
        }

        function renderPreviousTab() {
            if (!state.previousWeekReport) {
                return `
                    <div class="bg-white rounded-lg shadow p-12 text-center">
                        <p class="text-gray-500 text-xl">No previous week report saved.</p>
                        <p class="text-gray-400 mt-2">Generate a report and save it as previous week.</p>
                    </div>
                `;
            }
            
            const report = state.previousWeekReport;
            const totals = calculateTotals(report.data);
            
            return `
                <div class="space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        ${renderSummaryCard('Mapped DT', totals.mappedDT, 'bg-blue-500')}
                        ${renderSummaryCard('HT Poles', totals.htPoles, 'bg-purple-500')}
                        ${renderSummaryCard('LT Poles', totals.ltPoles, 'bg-green-500')}
                        ${renderSummaryCard('Consumer Points', totals.consumerPoints, 'bg-orange-500')}
                        ${renderSummaryCard('Issue Log', totals.issueLog, 'bg-red-500')}
                    </div>
                    
                    <!-- Report Info -->
                    <div class="bg-white rounded-lg shadow p-4 flex justify-between items-center">
                        <div>
                            <span class="text-gray-600">Date Range: </span>
                            <span class="font-bold">${report.dateRange.start} to ${report.dateRange.end}</span>
                            <span class="text-gray-400 ml-4">Saved: ${new Date(report.savedAt).toLocaleString()}</span>
                        </div>
                        <button onclick="exportToExcel(state.previousWeekReport, 'previous_week_${report.dateRange.start}_${report.dateRange.end}.xlsx')"
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            üì• Export to Excel
                        </button>
                    </div>
                    
                    <!-- Report Table -->
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-600 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left" style="min-width: 350px;">Feeder Name</th>
                                    <th class="px-4 py-3 text-center" colspan="2">Mapped DT</th>
                                    <th class="px-4 py-3 text-center" colspan="2">HT Poles</th>
                                    <th class="px-4 py-3 text-center" colspan="2">LT Poles</th>
                                    <th class="px-4 py-3 text-center" colspan="2">Consumer Points</th>
                                    <th class="px-4 py-3 text-center" colspan="2">Issue Log</th>
                                </tr>
                                <tr class="bg-gray-500">
                                    <th class="px-4 py-2"></th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                    <th class="px-4 py-2 text-center">Weekly</th>
                                    <th class="px-4 py-2 text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${report.data.map((row, idx) => `
                                    <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="px-4 py-3 border-r" style="word-break: break-all;">${row.feederName}</td>
                                        <td class="px-4 py-3 text-center">${row.mappedDT.weekly}</td>
                                        <td class="px-4 py-3 text-center">${row.mappedDT.total}</td>
                                        <td class="px-4 py-3 text-center">${row.htPoles.weekly}</td>
                                        <td class="px-4 py-3 text-center">${row.htPoles.total}</td>
                                        <td class="px-4 py-3 text-center">${row.ltPoles.weekly}</td>
                                        <td class="px-4 py-3 text-center">${row.ltPoles.total}</td>
                                        <td class="px-4 py-3 text-center">${row.consumerPoints.weekly}</td>
                                        <td class="px-4 py-3 text-center">${row.consumerPoints.total}</td>
                                        <td class="px-4 py-3 text-center">${row.issueLog.weekly}</td>
                                        <td class="px-4 py-3 text-center">${row.issueLog.total}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderComparisonTab() {
            if (!state.generatedReport && !state.previousWeekReport) {
                return `
                    <div class="bg-white rounded-lg shadow p-12 text-center">
                        <p class="text-gray-500 text-xl">No reports available for comparison.</p>
                        <p class="text-gray-400 mt-2">Generate a report and/or save a previous week report first.</p>
                    </div>
                `;
            }
            
            // Merge feeders from both reports
            const allFeeders = new Set();
            const prevData = {};
            const currData = {};
            
            if (state.previousWeekReport) {
                state.previousWeekReport.data.forEach(row => {
                    allFeeders.add(row.feederName);
                    prevData[row.feederName] = row;
                });
            }
            
            if (state.generatedReport) {
                state.generatedReport.data.forEach(row => {
                    allFeeders.add(row.feederName);
                    currData[row.feederName] = row;
                });
            }
            
            const feeders = Array.from(allFeeders).sort();
            
            return `
                <div class="space-y-6">
                    <!-- Date Info -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-100 rounded">
                                <h3 class="font-bold text-gray-700">üìã Previous Week</h3>
                                ${state.previousWeekReport ? `
                                    <p class="text-sm text-gray-600">${state.previousWeekReport.dateRange.start} to ${state.previousWeekReport.dateRange.end}</p>
                                ` : '<p class="text-sm text-gray-400">Not available</p>'}
                            </div>
                            <div class="p-4 bg-blue-100 rounded">
                                <h3 class="font-bold text-blue-700">üìä Current Week</h3>
                                ${state.generatedReport ? `
                                    <p class="text-sm text-blue-600">${state.generatedReport.dateRange.start} to ${state.generatedReport.dateRange.end}</p>
                                ` : '<p class="text-sm text-gray-400">Not available</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Table -->
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="px-3 py-3 text-left" style="min-width: 300px;">Feeder Name</th>
                                    <th class="px-3 py-2 text-center bg-gray-600" colspan="2">Mapped DT</th>
                                    <th class="px-3 py-2 text-center bg-purple-700" colspan="2">HT Poles</th>
                                    <th class="px-3 py-2 text-center bg-green-700" colspan="2">LT Poles</th>
                                    <th class="px-3 py-2 text-center bg-orange-600" colspan="2">Consumer Pts</th>
                                    <th class="px-3 py-2 text-center bg-red-700" colspan="2">Issue Log</th>
                                </tr>
                                <tr class="bg-gray-700 text-xs">
                                    <th class="px-3 py-2"></th>
                                    <th class="px-3 py-2 text-center">Prev</th>
                                    <th class="px-3 py-2 text-center">Curr</th>
                                    <th class="px-3 py-2 text-center">Prev</th>
                                    <th class="px-3 py-2 text-center">Curr</th>
                                    <th class="px-3 py-2 text-center">Prev</th>
                                    <th class="px-3 py-2 text-center">Curr</th>
                                    <th class="px-3 py-2 text-center">Prev</th>
                                    <th class="px-3 py-2 text-center">Curr</th>
                                    <th class="px-3 py-2 text-center">Prev</th>
                                    <th class="px-3 py-2 text-center">Curr</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${feeders.map((feeder, idx) => {
                                    const prev = prevData[feeder];
                                    const curr = currData[feeder];
                                    const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                                    const isNew = !prev && curr;
                                    const isMissing = prev && !curr;
                                    
                                    return `
                                        <tr class="${bgClass}">
                                            <td class="px-3 py-2 border-r" style="word-break: break-all;">
                                                ${feeder}
                                                ${isNew ? '<span class="ml-1 text-xs text-green-600">(new)</span>' : ''}
                                                ${isMissing ? '<span class="ml-1 text-xs text-red-600">(not in current)</span>' : ''}
                                            </td>
                                            ${renderComparisonCell(prev?.mappedDT?.total, curr?.mappedDT?.total)}
                                            ${renderComparisonCell(prev?.htPoles?.total, curr?.htPoles?.total)}
                                            ${renderComparisonCell(prev?.ltPoles?.total, curr?.ltPoles?.total)}
                                            ${renderComparisonCell(prev?.consumerPoints?.total, curr?.consumerPoints?.total)}
                                            ${renderComparisonCell(prev?.issueLog?.total, curr?.issueLog?.total)}
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderComparisonCell(prev, curr) {
            const prevVal = prev ?? '-';
            const currVal = curr ?? '-';
            
            let diffClass = '';
            if (prev !== undefined && curr !== undefined) {
                if (curr > prev) diffClass = 'bg-green-100 text-green-700';
                else if (curr < prev) diffClass = 'bg-red-100 text-red-700';
            }
            
            return `
                <td class="px-3 py-2 text-center border-r">${prevVal}</td>
                <td class="px-3 py-2 text-center ${diffClass}">${currVal}</td>
            `;
        }

        function renderCorrectionModal() {
            const currentFeeder = state.unmatchedFeeders[0];
            if (!currentFeeder) {
                state.showCorrectionModal = false;
                render();
                return '';
            }
            
            const lookupFeeders = Object.values(state.feederLookup);
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full mx-4">
                        <h2 class="text-xl font-bold mb-4">‚ö†Ô∏è Unmatched Feeder Found</h2>
                        <p class="text-gray-600 mb-2">The following feeder from Issue Log doesn't match any lookup:</p>
                        <p class="font-bold text-lg mb-4 p-3 bg-yellow-100 rounded">${currentFeeder}</p>
                        <p class="text-gray-600 mb-2">Select the correct feeder:</p>
                        
                        <input type="text" id="correctionSearch" placeholder="Search feeders..." 
                            class="w-full px-3 py-2 border rounded mb-2 focus:ring-2 focus:ring-blue-500"
                            oninput="filterCorrectionDropdown()">
                        
                        <div id="correctionList" class="max-h-60 overflow-y-auto border rounded mb-4">
                            <div class="p-2 bg-yellow-100 cursor-pointer hover:bg-yellow-200"
                                 onclick="applyCorrection('${encodeURIComponent(currentFeeder)}', '${encodeURIComponent(currentFeeder)}')">
                                üìå Keep as: ${currentFeeder}
                            </div>
                            ${lookupFeeders.map(f => `
                                <div class="p-2 cursor-pointer hover:bg-blue-100" data-feeder="${f.toLowerCase()}"
                                     onclick="applyCorrection('${encodeURIComponent(currentFeeder)}', '${encodeURIComponent(f)}')">
                                    ${f}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-between">
                            <button onclick="skipAllCorrections()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Skip All
                            </button>
                            <span class="text-gray-400">${state.unmatchedFeeders.length} remaining</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterCorrectionDropdown() {
            const search = document.getElementById('correctionSearch').value.toLowerCase();
            const items = document.querySelectorAll('#correctionList [data-feeder]');
            items.forEach(item => {
                const feeder = item.getAttribute('data-feeder');
                item.style.display = feeder.includes(search) ? 'block' : 'none';
            });
        }

        function applyCorrection(encodedOld, encodedNew) {
            const oldFeeder = decodeURIComponent(encodedOld);
            const newFeeder = decodeURIComponent(encodedNew);
            
            state.feederCorrections[oldFeeder] = newFeeder;
            state.unmatchedFeeders.shift();
            
            if (state.unmatchedFeeders.length === 0) {
                state.showCorrectionModal = false;
                // Regenerate report with corrections
                generateReport();
            } else {
                render();
            }
        }

        function skipAllCorrections() {
            state.unmatchedFeeders = [];
            state.showCorrectionModal = false;
            render();
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function attachEventListeners() {
            // Tab clicks
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.onclick = () => {
                    state.activeTab = btn.dataset.tab;
                    render();
                };
            });
            
            // Feeder Lookup file
            const feederLookupInput = document.getElementById('feederLookupFile');
            if (feederLookupInput) {
                feederLookupInput.onchange = async (e) => {
                    if (e.target.files[0]) {
                        try {
                            const data = await parseExcelFile(e.target.files[0]);
                            state.feederLookup = parseFeederLookup(data);
                            saveToStorage();
                            render();
                        } catch (err) {
                            alert('Error parsing file: ' + err.message);
                        }
                    }
                };
            }
            
            // Asset file uploads
            ['mappedDT', 'htPoles', 'ltPoles', 'consumerPoints', 'issueLog'].forEach(type => {
                const input = document.getElementById(`${type}File`);
                if (input) {
                    input.onchange = async (e) => {
                        if (e.target.files[0]) {
                            try {
                                const data = await parseExcelFile(e.target.files[0]);
                                state.uploadedFiles[type] = data;
                                render();
                            } catch (err) {
                                alert('Error parsing file: ' + err.message);
                            }
                        }
                    };
                }
            });
            
            // Date inputs
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if (startDateInput) {
                startDateInput.onchange = (e) => {
                    state.dateRange.start = e.target.value;
                };
            }
            if (endDateInput) {
                endDateInput.onchange = (e) => {
                    state.dateRange.end = e.target.value;
                };
            }
            
            // Generate button
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.onclick = () => {
                    const hasFiles = Object.values(state.uploadedFiles).some(f => f !== null);
                    if (!hasFiles) {
                        alert('Please upload at least one asset file.');
                        return;
                    }
                    generateReport();
                    state.activeTab = 'report';
                    render();
                };
            }
            
            // Close dropdowns when clicking outside
            document.onclick = (e) => {
                if (!e.target.closest('.feeder-name-display') && !e.target.closest('[id^="dropdown-"]')) {
                    document.querySelectorAll('[id^="dropdown-"]').forEach(d => d.classList.add('hidden'));
                }
            };
        }

        // ============================================
        // INITIALIZE
        // ============================================
        loadFromStorage();
        render();
    </script>
</body>
</html>
